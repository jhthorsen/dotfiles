#!/bin/bash
# This script exists since "man" in maxos 12.3 seems to be very buggy,
# but it also add colors to the man pages.

[ -z "$MANPATH" ] && exec /usr/bin/man $*;
echo $1 | grep -q "^-" && exec /usr/bin/man $*;

SECTION="1 2 3 4 5 6 7 8";
echo $1 | grep -q '^[1-8]$' && SECTION="$1" && shift;
PAGE="$1"; shift;
SEARCH="$1"; shift;
[ "x$SEARCH" != "x" ] && SEARCH="--pattern=$SEARCH";

export LESS="X";
export LESS_TERMCAP_mb=$(tput blink);
export LESS_TERMCAP_md=$(tput bold; tput setaf 4);
export LESS_TERMCAP_me=$(tput sgr0);
export LESS_TERMCAP_se=$(tput rmso);
export LESS_TERMCAP_so=$(tput smso);
export LESS_TERMCAP_ue=$(tput sgr0);
export LESS_TERMCAP_us=$(tput setaf 2);
export PAGER="${PAGER:-less}"

for d in $(echo $MANPATH | sed 's/:/ /g'); do
  for s in $SECTION; do
    p="$d/man$s/$PAGE.$s";
    [ -r "$p" ] || continue;
    [ -n "$DEBUG" ] && echo echo "groff -mman -Tutf8 $p | $PAGER $SEARCH" >&2;
    groff -mman -Tascii "$p" 2>/dev/null | $PAGER $SEARCH;
    [ "$?" = "0" ] && exit 0;
  done
done

# Fallback in case no man page could be found
/usr/bin/man $*;
