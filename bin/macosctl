#!/bin/bash

runx() {
  "$*";
  exit $?;
}

run_pfctl() {
  if [ "$4" = "" ]; then
    echo "Usage: macosctl fwd <source-port> <dest-port> [dest-ip]";
    exit;
  fi

  echo "rdr pass inet proto tcp from any to any port $2 -> $4 port $3" | sudo pfctl -;
}

run_dns_flush () {
  sudo dscacheutil -flushcache;
  sudo killall -HUP mDNSResponder;
}

[ "$1" = "app-id" ] && runx osascript -e 'id of app "Finder"';
[ "$1" = "fwd" ] && runx run_pfctl "$2" "$3" "$4";
[ "$1" = "dns-flush" ] && runx run_dns_flush;
[ "$1" = "leases" ] && runx sudo cat /private/var/db/dhcpd_leases;

echo "$0 [app-id|fwd|dns-flush|leases-add]";
